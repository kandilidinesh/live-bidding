<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Car Auction - Modern Test Client</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f6fa; }
    .container { max-width: 600px; margin: 2em auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; }
    h2, h3 { margin-top: 0; }
    .auction-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 1em; }
    .auction-card {
      background: #f9fbff;
      border: 1px solid #e3e8f0;
      border-radius: 8px;
      box-shadow: 0 1px 4px #0001;
      padding: 1.2em 1.5em;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: box-shadow 0.2s, border 0.2s;
      position: relative;
    }
    .auction-card:hover {
      box-shadow: 0 4px 16px #0002;
      border-color: #b3c6e0;
      background: #f0f4ff;
    }
    .auction-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 0.2em;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .auction-badges {
      position: absolute;
      top: 1.2em;
      right: 1.5em;
      display: flex;
      gap: 0.5em;
      align-items: center;
    }
    .auction-meta {
      color: #555;
      font-size: 0.97em;
      margin-bottom: 0.2em;
    }
    .auction-status {
      display: inline-block;
      font-size: 0.85em;
      font-weight: 600;
      padding: 0.2em 0.7em;
      border-radius: 12px;
      background: #e3e8f0;
      color: #1976d2;
      margin-left: 0.5em;
    }
    .auction-status.LIVE { background: #e3fbe3; color: #219653; }
    .auction-status.ENDED { background: #ffe3e3; color: #d32f2f; }
    .auction-status.UPCOMING { background: #fffbe3; color: #b59f00; }
    .hidden { display: none; }
    .form-row { margin: 1em 0; }
    label { display: block; margin-bottom: 0.3em; }
    select, input, button { padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #1976d2; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #125ea8; }
    #log { border: 1px solid #ccc; padding: 1em; height: 120px; overflow-y: auto; background: #fafafa; margin-top: 1em; font-size: 0.95em; }
    .back-btn { background: #eee; color: #333; margin-bottom: 1em; }
    .back-btn:hover { background: #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Live Car Auction</h2>
    <div id="auctionListView">
      <h3>Available Auctions</h3>
      <ul id="auctionList" class="auction-list"></ul>
    </div>
    <div id="auctionRoomView" class="hidden">
      <button class="back-btn" onclick="leaveAuctionRoom()">&larr; Back to Auctions</button>
      <h3 id="auctionRoomTitle"></h3>
      <div class="form-row">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
      </div>
      <div class="form-row">
        <label for="bidAmount">Bid Amount:</label>
        <input type="number" id="bidAmount" value="1000" min="1" />
        <button onclick="placeBid()">Place Bid</button>
      </div>
      <div id="log"></div>
    </div>
  </div>
  <script>
    // --- Config ---
    const API_BASE = 'http://localhost:3000';
    const SOCKET_URL = 'http://localhost:3000/auctions';
    // --- State ---
    let users = [];
    let socket = null;
    let currentAuction = null;
    // --- DOM Elements ---
    const auctionListView = document.getElementById('auctionListView');
    const auctionRoomView = document.getElementById('auctionRoomView');
    const auctionList = document.getElementById('auctionList');
    const auctionRoomTitle = document.getElementById('auctionRoomTitle');
    const userSelect = document.getElementById('userSelect');
    const bidAmount = document.getElementById('bidAmount');
    const logDiv = document.getElementById('log');
    // --- Init ---
    fetchAuctions();
    fetchUsers();
    function fetchAuctions() {
      fetch(`${API_BASE}/auctions`, { headers: { 'x-api-key': 'my-secret-api-key' } })
        .then(res => res.json())
        .then(data => renderAuctionList(data))
        .catch(() => auctionList.innerHTML = '<li style="color:red">Failed to load auctions</li>');
    }
    function renderAuctionList(auctions) {
      auctionList.innerHTML = '';
      if (!auctions.length) {
        auctionList.innerHTML = '<li>No auctions available</li>';
        return;
      }
      auctions.forEach(auction => {
        const card = document.createElement('li');
        card.className = 'auction-card';
        card.onclick = () => enterAuctionRoom(auction);
        // Badges container (top right)
        const badges = document.createElement('div');
        badges.className = 'auction-badges';
        // Auction ID badge
        const idBadge = document.createElement('span');
        idBadge.style = 'background:#e0e7ef;color:#333;font-size:0.85em;padding:0.2em 0.7em;border-radius:12px;';
        idBadge.textContent = `#${auction.id}`;
        // Auction status badge
        const status = document.createElement('span');
        status.className = 'auction-status ' + (auction.status || '');
        status.textContent = auction.status || 'UNKNOWN';
        badges.appendChild(idBadge);
        badges.appendChild(status);
        // Title (Car name)
        const title = document.createElement('div');
        title.className = 'auction-title';
        title.textContent = auction.carName || auction.carId || 'Unknown Car';
        // Meta info
        const meta = document.createElement('div');
        meta.className = 'auction-meta';
        meta.innerHTML = `<b>Car ID:</b> ${auction.carId || '-'} &nbsp; <b>Start:</b> ${auction.startTime ? new Date(auction.startTime).toLocaleString() : '-'} &nbsp; <b>End:</b> ${auction.endTime ? new Date(auction.endTime).toLocaleString() : '-'}`;
        // Highest bid
        const bid = document.createElement('div');
        bid.className = 'auction-meta';
        bid.innerHTML = `<b>Highest Bid:</b> $${auction.currentHighestBid ?? '-'} &nbsp; <b>Starting Bid:</b> $${auction.startingBid ?? '-'}`;
        card.appendChild(badges);
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(bid);
        auctionList.appendChild(card);
      });
    }
    function fetchUsers() {
      fetch(`${API_BASE}/users`, { headers: { 'x-api-key': 'my-secret-api-key' } })
        .then(res => res.json())
        .then(data => {
          users = data;
          populateUsers();
        })
        .catch(() => {
          userSelect.innerHTML = '<option disabled>Failed to load users</option>';
        });
    }
    function populateUsers() {
      userSelect.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = `${u.username || u.name || u.email || 'User'} (ID: ${u.id})`;
        userSelect.appendChild(opt);
      });
    }
    function enterAuctionRoom(auction) {
      currentAuction = auction;
      auctionListView.classList.add('hidden');
      auctionRoomView.classList.remove('hidden');
      auctionRoomTitle.textContent = `Auction #${auction.id} | Car: ${auction.carId}`;
      logDiv.innerHTML = '';
      connectSocket(auction.id);
    }
    function leaveAuctionRoom() {
      if (socket) socket.disconnect();
      currentAuction = null;
      auctionRoomView.classList.add('hidden');
      auctionListView.classList.remove('hidden');
    }
    function connectSocket(auctionId) {
      if (socket) socket.disconnect();
      socket = io(SOCKET_URL, { transports: ['websocket'] });
      socket.on('connect', () => {
        log('Connected to auction room');
        socket.emit('joinAuction', { auctionId });
      });
      socket.on('disconnect', () => log('Disconnected from server'));
      socket.on('bidUpdate', data => log('Bid Update: ' + JSON.stringify(data)));
      socket.on('auctionEnded', data => log('<b style="color:green">Auction Ended: ' + JSON.stringify(data) + '</b>'));
      socket.on('auctionStarted', data => log('Auction Started: ' + JSON.stringify(data)));
      socket.on('bidError', msg => log('<span style="color:red">Bid Error: ' + msg + '</span>'));
    }
    function placeBid() {
      if (!currentAuction) return;
      const auctionId = currentAuction.id;
      const userId = parseInt(userSelect.value);
      const amount = parseFloat(bidAmount.value);
      socket.emit('placeBid', { auctionId, userId, amount });
      log('Placed bid: ' + amount + ' (User: ' + userId + ', Auction: ' + auctionId + ')');
    }
    function log(msg) {
      logDiv.innerHTML += msg + '<br />';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  </script>
</body>
</html>
