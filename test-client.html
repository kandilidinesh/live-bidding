<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Car Auction - Modern Test Client</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f6fa; }
    .container { max-width: 600px; margin: 2em auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; }
    h2, h3 { margin-top: 0; }
    .auction-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 1em; }
    .auction-card {
      background: #f9fbff;
      border: 1px solid #e3e8f0;
      border-radius: 8px;
      box-shadow: 0 1px 4px #0001;
      padding: 1.2em 1.5em;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: box-shadow 0.2s, border 0.2s;
      position: relative;
    }
    .auction-card:hover {
      box-shadow: 0 4px 16px #0002;
      border-color: #b3c6e0;
      background: #f0f4ff;
    }
    .auction-title {
      font-size: 1.18em;
      font-weight: 700;
      margin-bottom: 0.5em;
      letter-spacing: 0.01em;
      color: #1a2330;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .auction-details-row {
      display: flex;
      gap: 1.5em;
      margin-bottom: 0.3em;
      flex-wrap: wrap;
    }
    .auction-meta-block {
      flex: 1 1 180px;
      background: #f3f6fa;
      border-radius: 6px;
      padding: 0.5em 0.9em;
      font-size: 0.97em;
      color: #3a4664;
      margin-bottom: 0.2em;
      min-width: 140px;
      box-sizing: border-box;
    }
    .auction-meta-block b {
      color: #1976d2;
      font-weight: 600;
    }
    .auction-divider {
      height: 1px;
      background: #e3e8f0;
      border: none;
      margin: 0.7em 0 0.5em 0;
    }
    .auction-badges {
      position: absolute;
      top: 1.2em;
      right: 1.5em;
      display: flex;
      gap: 0.5em;
      align-items: center;
    }
    .auction-meta {
      color: #555;
      font-size: 0.97em;
      margin-bottom: 0.2em;
    }
    .auction-status {
      display: inline-block;
      font-size: 0.85em;
      font-weight: 600;
      padding: 0.2em 0.7em;
      border-radius: 12px;
      background: #e3e8f0;
      color: #1976d2;
      margin-left: 0.5em;
    }
    .auction-status.LIVE { background: #e3fbe3; color: #219653; }
    .auction-status.ENDED { background: #ffe3e3; color: #d32f2f; }
    .auction-status.UPCOMING { background: #fffbe3; color: #b59f00; }
    .hidden { display: none; }
    .form-row { margin: 1em 0; }
    label { display: block; margin-bottom: 0.3em; }
    select, input, button { padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #1976d2; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #125ea8; }
    #log { border: 1px solid #ccc; padding: 1em; height: 120px; overflow-y: auto; background: #fafafa; margin-top: 1em; font-size: 0.95em; }
    .back-btn { background: #eee; color: #333; margin-bottom: 1em; }
    .back-btn:hover { background: #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.2em;">
      <span style="display:inline-flex;align-items:center;justify-content:center;width:1.7em;height:1.7em;background:#e3e8f0;border-radius:50%;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="5" rx="2"/><path d="M5 16v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2"/><circle cx="7.5" cy="18.5" r="1.5"/><circle cx="16.5" cy="18.5" r="1.5"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      </span>
      <span>Real-Time Car Bidding Platform</span>
    </h2>
    <div style="color:#555;font-size:1.05em;margin-bottom:1.5em;">
      Join live car auctions, place real-time bids, and experience competitive bidding with instant updates.
    </div>
    <div id="auctionListView">
      <h3 style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.7em;">
        <span style="display:inline-flex;align-items:center;justify-content:center;width:1.3em;height:1.3em;background:#e3e8f0;border-radius:50%;">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="14" height="10" rx="2"/><path d="M7 9h6"/><path d="M7 13h4"/></svg>
        </span>
        <span>Auctions</span>
        <span style="font-size:0.95em;color:#888;font-weight:400;margin-left:auto;">(Click a card to join bidding room)</span>
      </h3>
      <ul id="auctionList" class="auction-list"></ul>
    </div>
    <div id="auctionRoomView" class="hidden">
      <button class="back-btn" onclick="leaveAuctionRoom()">&larr; Back to Auctions</button>
      <h3 id="auctionRoomTitle"></h3>
      <div class="form-row">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
      </div>
      <div class="form-row">
        <label for="bidAmount">Bid Amount:</label>
        <input type="number" id="bidAmount" value="1000" min="1" />
        <button onclick="placeBid()">Place Bid</button>
      </div>
      <div id="log"></div>
    </div>
  </div>
  <script>
    // --- Config ---
    const API_BASE = 'http://localhost:3000';
    const SOCKET_URL = 'http://localhost:3000/auctions';
    // --- State ---
    let users = [];
    let socket = null;
    let currentAuction = null;
    // --- DOM Elements ---
    const auctionListView = document.getElementById('auctionListView');
    const auctionRoomView = document.getElementById('auctionRoomView');
    const auctionList = document.getElementById('auctionList');
    const auctionRoomTitle = document.getElementById('auctionRoomTitle');
    const userSelect = document.getElementById('userSelect');
    const bidAmount = document.getElementById('bidAmount');
    const logDiv = document.getElementById('log');
    // --- Init ---
    fetchAuctions();
    fetchUsers();
    function fetchAuctions() {
      fetch(`${API_BASE}/auctions`, { headers: { 'x-api-key': 'my-secret-api-key' } })
        .then(res => res.json())
        .then(data => renderAuctionList(data))
        .catch(() => auctionList.innerHTML = '<li style="color:red">Failed to load auctions</li>');
    }
    function renderAuctionList(auctions) {
      auctionList.innerHTML = '';
      if (!auctions.length) {
        auctionList.innerHTML = '<li>No auctions available</li>';
        return;
      }
      auctions.forEach(auction => {
        const card = document.createElement('li');
        card.className = 'auction-card';
        card.onclick = () => enterAuctionRoom(auction);
        // Badges container (top right)
        const badges = document.createElement('div');
        badges.className = 'auction-badges';
        // Auction ID badge
        const idBadge = document.createElement('span');
        idBadge.style = 'background:#e0e7ef;color:#333;font-size:0.85em;padding:0.2em 0.7em;border-radius:12px;';
        idBadge.textContent = `#${auction.id}`;
        // Auction status badge
        const status = document.createElement('span');
        status.className = 'auction-status ' + (auction.status || '');
        status.textContent = auction.status || 'UNKNOWN';
        badges.appendChild(idBadge);
        badges.appendChild(status);
        // Title (Car name)
        const title = document.createElement('div');
        title.className = 'auction-title';
        title.textContent = auction.carName || auction.carId || 'Unknown Car';
        // Details row (meta and bid info)
        const detailsRow = document.createElement('div');
        detailsRow.className = 'auction-details-row';
        // Meta block
        const metaBlock = document.createElement('div');
        metaBlock.className = 'auction-meta-block';
        metaBlock.innerHTML = `<b>Car ID:</b> ${auction.carId || '-'}<br><b>Start:</b> ${auction.startTime ? new Date(auction.startTime).toLocaleString() : '-'}<br><b>End:</b> ${auction.endTime ? new Date(auction.endTime).toLocaleString() : '-'}`;
        // Bid block
        const bidBlock = document.createElement('div');
        bidBlock.className = 'auction-meta-block';
        bidBlock.innerHTML = `<b>Highest Bid:</b> $${auction.currentHighestBid ?? '-'}<br><b>Starting Bid:</b> $${auction.startingBid ?? '-'}`;
        detailsRow.appendChild(metaBlock);
        detailsRow.appendChild(bidBlock);
        // Compose card
        card.appendChild(badges);
        card.appendChild(title);
        card.appendChild(detailsRow);
        auctionList.appendChild(card);
      });
    }
    function fetchUsers() {
      fetch(`${API_BASE}/users`, { headers: { 'x-api-key': 'my-secret-api-key' } })
        .then(res => res.json())
        .then(data => {
          users = data;
          populateUsers();
        })
        .catch(() => {
          userSelect.innerHTML = '<option disabled>Failed to load users</option>';
        });
    }
    function populateUsers() {
      userSelect.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = `${u.username || u.name || u.email || 'User'} (ID: ${u.id})`;
        userSelect.appendChild(opt);
      });
    }
    function enterAuctionRoom(auction) {
      currentAuction = auction;
      auctionListView.classList.add('hidden');
      auctionRoomView.classList.remove('hidden');
      auctionRoomTitle.textContent = `Auction #${auction.id} | Car: ${auction.carId}`;
      logDiv.innerHTML = '';
      connectSocket(auction.id);
    }
    function leaveAuctionRoom() {
      if (socket) socket.disconnect();
      currentAuction = null;
      auctionRoomView.classList.add('hidden');
      auctionListView.classList.remove('hidden');
    }
    function connectSocket(auctionId) {
      if (socket) socket.disconnect();
      socket = io(SOCKET_URL, { transports: ['websocket'] });
      socket.on('connect', () => {
        log('Connected to auction room');
        socket.emit('joinAuction', { auctionId });
      });
      socket.on('disconnect', () => log('Disconnected from server'));
      socket.on('bidUpdate', data => log('Bid Update: ' + JSON.stringify(data)));
      socket.on('auctionEnded', data => log('<b style="color:green">Auction Ended: ' + JSON.stringify(data) + '</b>'));
      socket.on('auctionStarted', data => log('Auction Started: ' + JSON.stringify(data)));
      socket.on('bidError', msg => log('<span style="color:red">Bid Error: ' + msg + '</span>'));
    }
    function placeBid() {
      if (!currentAuction) return;
      const auctionId = currentAuction.id;
      const userId = parseInt(userSelect.value);
      const amount = parseFloat(bidAmount.value);
      socket.emit('placeBid', { auctionId, userId, amount });
      log('Placed bid: ' + amount + ' (User: ' + userId + ', Auction: ' + auctionId + ')');
    }
    function log(msg) {
      logDiv.innerHTML += msg + '<br />';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  </script>
</body>
</html>
